#!/usr/bin/env sh

# Pre-commit tasks
npx lint-staged

# Type check
npm run type-check

# Run tests on staged JavaScript/TypeScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$')
if [ -n "$STAGED_FILES" ]; then
  npm run test -- --bail
else
  echo "No JavaScript/TypeScript files staged for testing."
fi

# Check for sensitive data with improved pattern matching
# Only check for additions of sensitive data, not removals
# Ignore changes to this file itself
if [ -z "$(git diff --cached --name-only | grep -E '\.husky/pre-commit$')" ]; then
  matches=$(git diff --cached | grep "^+" | grep -iE '(password|secret|key|token)' | \
    grep -ivE '(keyframes|css-color-keywords|styled-components|StyledButton|background-color|border-color|color-scheme|text-decoration|key-value|tokenize|key:)')

  if [ ! -z "$matches" ]; then
    echo "Warning: Possible sensitive data detected in commit:"
    echo "$matches"
    echo "Please review the changes carefully."
    echo "If these are false positives, you can:"
    echo "1. Update the pre-commit hook patterns"
    echo "2. Use git commit --no-verify (if you're absolutely sure there's no sensitive data)"
    exit 1
  fi
fi